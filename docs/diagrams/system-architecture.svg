<svg width="1400" height="680" viewBox="0 0 1400 680" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="arch-title arch-desc">
  <title id="arch-title">Code Graph Server - System Architecture</title>
  <desc id="arch-desc">Node diagram: Client, MCP Server, Tool Handlers, Response Shaper, Graph Orchestrator, Hybrid Retriever, Memgraph, Vector Store.</desc>

  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1400" y2="680" gradientUnits="userSpaceOnUse">
      <stop stop-color="#F8FAFC"/>
      <stop offset="1" stop-color="#F0F4FF"/>
    </linearGradient>
    <marker id="arr" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <path d="M0 1 L9 5 L0 9 Z" fill="#475569"/>
    </marker>
    <marker id="arr-ret" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <path d="M0 1 L9 5 L0 9 Z" fill="#8B5CF6"/>
    </marker>
    <filter id="sh" x="-15%" y="-15%" width="130%" height="130%">
      <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#0F172A" flood-opacity="0.07"/>
    </filter>
    <style>
      .title   { font: 700 26px Inter, "Segoe UI", Arial, sans-serif; fill: #0F172A; }
      .caption { font: 500 14px Inter, "Segoe UI", Arial, sans-serif; fill: #64748B; }
      .zone    { font: 600 11px Inter, "Segoe UI", Arial, sans-serif; fill: #94A3B8; letter-spacing: 1.5px; }
      .box-h   { font: 700 15px Inter, "Segoe UI", Arial, sans-serif; fill: #1E293B; }
      .box-s   { font: 500 12px Inter, "Segoe UI", Arial, sans-serif; fill: #64748B; }
      .ret-lbl { font: 600 11px Inter, "Segoe UI", Arial, sans-serif; fill: #7C3AED; }
      .footer  { font: 500 13px Inter, "Segoe UI", Arial, sans-serif; fill: #64748B; }
    </style>
  </defs>

  <!-- Background -->
  <rect width="1400" height="680" fill="url(#bg)"/>

  <!-- Header -->
  <text x="60" y="58" class="title">Code Graph Server &#x2014; System Architecture</text>
  <text x="60" y="80" class="caption">MCP-native orchestration &#xB7; hybrid retrieval &#xB7; response shaping</text>

  <!-- Zone: Client -->
  <rect x="30"   y="104" width="242" height="476" rx="14" fill="#F1F5F9" stroke="#E2E8F0" stroke-width="1.5"/>
  <text x="151"  y="130" text-anchor="middle" class="zone">CLIENT</text>

  <!-- Zone: MCP Layer -->
  <rect x="284"  y="104" width="252" height="476" rx="14" fill="#EFF6FF" stroke="#BFDBFE" stroke-width="1.5"/>
  <text x="410"  y="130" text-anchor="middle" class="zone">MCP LAYER</text>

  <!-- Zone: Processing -->
  <rect x="548"  y="104" width="570" height="476" rx="14" fill="#F0FDF4" stroke="#BBF7D0" stroke-width="1.5"/>
  <text x="833"  y="130" text-anchor="middle" class="zone">PROCESSING</text>

  <!-- Zone: Storage -->
  <rect x="1130" y="104" width="244" height="476" rx="14" fill="#ECFDF5" stroke="#6EE7B7" stroke-width="1.5"/>
  <text x="1252" y="130" text-anchor="middle" class="zone">STORAGE</text>

  <!-- Box: Client -->
  <g filter="url(#sh)">
    <rect x="51"  y="342" width="200" height="76" rx="10" fill="#FFF" stroke="#93C5FD" stroke-width="2"/>
  </g>
  <rect x="51"  y="342" width="5" height="76" rx="2" fill="#3B82F6"/>
  <text x="163" y="373" text-anchor="middle" class="box-h">Agent / Client</text>
  <text x="163" y="394" text-anchor="middle" class="box-s">Copilot &#xB7; MCP CLI</text>

  <!-- Box: MCP Server (tall â€” bridges both processing rows) -->
  <g filter="url(#sh)">
    <rect x="304" y="308" width="212" height="144" rx="10" fill="#FFF" stroke="#818CF8" stroke-width="2"/>
  </g>
  <rect x="304" y="308" width="5" height="144" rx="2" fill="#6366F1"/>
  <text x="411" y="368" text-anchor="middle" class="box-h">MCP Server</text>
  <text x="411" y="390" text-anchor="middle" class="box-s">HTTP / stdio transport</text>
  <text x="411" y="410" text-anchor="middle" class="box-s">session-scoped context</text>

  <!-- Box: Tool Handlers (top row) -->
  <g filter="url(#sh)">
    <rect x="568" y="256" width="212" height="76" rx="10" fill="#FFF" stroke="#4ADE80" stroke-width="2"/>
  </g>
  <rect x="568" y="256" width="5" height="76" rx="2" fill="#22C55E"/>
  <text x="675" y="287" text-anchor="middle" class="box-h">Tool Handlers</text>
  <text x="675" y="308" text-anchor="middle" class="box-s">routing &#xB7; execution</text>

  <!-- Box: Response Shaper (bottom row) -->
  <g filter="url(#sh)">
    <rect x="568" y="428" width="212" height="76" rx="10" fill="#FFF" stroke="#C084FC" stroke-width="2"/>
  </g>
  <rect x="568" y="428" width="5" height="76" rx="2" fill="#A855F7"/>
  <text x="675" y="459" text-anchor="middle" class="box-h">Response Shaper</text>
  <text x="675" y="480" text-anchor="middle" class="box-s">compact &#xB7; balanced &#xB7; debug</text>

  <!-- Box: Graph Orchestrator (top row) -->
  <g filter="url(#sh)">
    <rect x="848" y="256" width="222" height="76" rx="10" fill="#FFF" stroke="#FCD34D" stroke-width="2"/>
  </g>
  <rect x="848" y="256" width="5" height="76" rx="2" fill="#F59E0B"/>
  <text x="960" y="287" text-anchor="middle" class="box-h">Graph Orchestrator</text>
  <text x="960" y="308" text-anchor="middle" class="box-s">indexing &#xB7; rebuild pipeline</text>

  <!-- Box: Hybrid Retriever (bottom row) -->
  <g filter="url(#sh)">
    <rect x="848" y="428" width="222" height="76" rx="10" fill="#FFF" stroke="#FB7185" stroke-width="2"/>
  </g>
  <rect x="848" y="428" width="5" height="76" rx="2" fill="#F43F5E"/>
  <text x="960" y="459" text-anchor="middle" class="box-h">Hybrid Retriever</text>
  <text x="960" y="480" text-anchor="middle" class="box-s">Vector &#xB7; BM25 &#xB7; Graph &#xB7; RRF</text>

  <!-- Box: Memgraph (top row) -->
  <g filter="url(#sh)">
    <rect x="1148" y="256" width="208" height="76" rx="10" fill="#FFF" stroke="#34D399" stroke-width="2"/>
  </g>
  <rect x="1148" y="256" width="5" height="76" rx="2" fill="#10B981"/>
  <text x="1253" y="287" text-anchor="middle" class="box-h">Memgraph</text>
  <text x="1253" y="308" text-anchor="middle" class="box-s">code + temporal graph</text>

  <!-- Box: Vector Store (bottom row) -->
  <g filter="url(#sh)">
    <rect x="1148" y="428" width="208" height="76" rx="10" fill="#FFF" stroke="#38BDF8" stroke-width="2"/>
  </g>
  <rect x="1148" y="428" width="5" height="76" rx="2" fill="#0EA5E9"/>
  <text x="1253" y="459" text-anchor="middle" class="box-h">Vector Store</text>
  <text x="1253" y="480" text-anchor="middle" class="box-s">Qdrant-compatible</text>

  <!-- Arrows (forward flow, slate) -->

  <!-- Client to MCP Server (horizontal) -->
  <path d="M251 380 H304"
        stroke="#475569" stroke-width="2.5" fill="none" marker-end="url(#arr)"/>

  <!-- MCP Server to Tool Handlers (elbow up) -->
  <path d="M516 338 H542 V294 H568"
        stroke="#475569" stroke-width="2.5" fill="none" marker-end="url(#arr)"/>

  <!-- MCP Server to Response Shaper (elbow down) -->
  <path d="M516 422 H542 V466 H568"
        stroke="#475569" stroke-width="2.5" fill="none" marker-end="url(#arr)"/>

  <!-- Tool Handlers to Graph Orchestrator (horizontal) -->
  <path d="M780 294 H848"
        stroke="#475569" stroke-width="2.5" fill="none" marker-end="url(#arr)"/>

  <!-- Tool Handlers to Hybrid Retriever (elbow down) -->
  <path d="M780 314 H814 V466 H848"
        stroke="#475569" stroke-width="2.5" fill="none" marker-end="url(#arr)"/>

  <!-- Graph Orchestrator to Memgraph (horizontal) -->
  <path d="M1070 294 H1148"
        stroke="#475569" stroke-width="2.5" fill="none" marker-end="url(#arr)"/>

  <!-- Hybrid Retriever to Vector Store (horizontal) -->
  <path d="M1070 466 H1148"
        stroke="#475569" stroke-width="2.5" fill="none" marker-end="url(#arr)"/>

  <!-- Hybrid Retriever to Memgraph (elbow up) -->
  <path d="M1070 448 H1112 V294 H1148"
        stroke="#475569" stroke-width="2.5" fill="none" marker-end="url(#arr)"/>

  <!-- Return: Response Shaper to Client (dashed violet, bottom bypass) -->
  <path d="M675 504 V558 H151 V418"
        stroke="#8B5CF6" stroke-width="2" fill="none"
        stroke-dasharray="6 4" marker-end="url(#arr-ret)"/>
  <text x="406" y="576" text-anchor="middle" class="ret-lbl">shaped response</text>

  <!-- Footer -->
  <rect x="30" y="604" width="1340" height="44" rx="10" fill="#E2E8F0"/>
  <text x="700" y="631" text-anchor="middle" class="footer">
    Queries are fused via Hybrid Retriever (vector + BM25 + graph with RRF) &#xB7; responses are shaped by budget profile before returning to the client.
  </text>
</svg>
