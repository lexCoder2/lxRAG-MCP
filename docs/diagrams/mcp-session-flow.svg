<svg width="1280" height="820" viewBox="0 0 1280 820" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-labelledby="flow-title flow-desc">
  <title id="flow-title">MCP HTTP Session Flow</title>
  <desc id="flow-desc">Sequence diagram: initialize, mcp-session-id capture, graph_set_workspace, graph_rebuild, repeatable query loop with shaped response.</desc>

  <defs>
    <linearGradient id="bg" x1="0" y1="0" x2="1280" y2="820" gradientUnits="userSpaceOnUse">
      <stop stop-color="#F8FAFC"/>
      <stop offset="1" stop-color="#F0F4FF"/>
    </linearGradient>
    <marker id="arr" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <path d="M0 1 L9 5 L0 9 Z" fill="#475569"/>
    </marker>
    <marker id="arr-ret" viewBox="0 0 10 10" refX="9" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
      <path d="M0 1 L9 5 L0 9 Z" fill="#8B5CF6"/>
    </marker>
    <filter id="sh" x="-15%" y="-15%" width="130%" height="130%">
      <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="#0F172A" flood-opacity="0.07"/>
    </filter>
    <style>
      .title   { font: 700 26px Inter, "Segoe UI", Arial, sans-serif; fill: #0F172A; }
      .caption { font: 500 14px Inter, "Segoe UI", Arial, sans-serif; fill: #64748B; }
      .zone-lbl{ font: 700 11px Inter, "Segoe UI", Arial, sans-serif; letter-spacing: .08em; }
      .box-h   { font: 700 15px Inter, "Segoe UI", Arial, sans-serif; fill: #1E293B; }
      .box-s   { font: 500 12px Inter, "Segoe UI", Arial, sans-serif; fill: #64748B; }
      .step    { font: 600 13px Inter, "Segoe UI", Arial, sans-serif; fill: #1E293B; }
      .ret-lbl { font: 600 13px Inter, "Segoe UI", Arial, sans-serif; fill: #7C3AED; }
      .note    { font: 500 11.5px Inter, "Segoe UI", Arial, sans-serif; fill: #64748B; }
      .footer  { font: 500 13px Inter, "Segoe UI", Arial, sans-serif; fill: #64748B; }
    </style>
  </defs>

  <!-- Background -->
  <rect width="1280" height="820" fill="url(#bg)"/>

  <!-- ── Header ─────────────────────────────────────────────────────── -->
  <text x="60" y="52" class="title">MCP HTTP Session Flow</text>
  <text x="60" y="74" class="caption">Session-scoped workspace context · required mcp-session-id propagation on every call after initialize</text>

  <!-- ── Zone: SETUP (steps 1–2) ────────────────────────────────────── -->
  <rect x="30" y="192" width="1220" height="154" rx="10" fill="#EFF6FF" opacity=".7"/>
  <rect x="30" y="192" width="5"    height="154" rx="2"  fill="#3B82F6"/>
  <text x="48" y="209" class="zone-lbl" fill="#2563EB">SETUP</text>

  <!-- ── Zone: INDEX (steps 3–4) ────────────────────────────────────── -->
  <rect x="30" y="358" width="1220" height="184" rx="10" fill="#EEF2FF" opacity=".7"/>
  <rect x="30" y="358" width="5"    height="184" rx="2"  fill="#6366F1"/>
  <text x="48" y="375" class="zone-lbl" fill="#4F46E5">INDEX</text>

  <!-- ── Zone: QUERY LOOP (step 5+) ───────────────────────────────────  -->
  <rect x="30" y="554" width="1220" height="174" rx="10" fill="#F0FDF4" opacity=".7"/>
  <rect x="30" y="554" width="5"    height="174" rx="2"  fill="#22C55E"/>
  <text x="48" y="571" class="zone-lbl" fill="#16A34A">QUERY LOOP</text>

  <!-- ── Participant: MCP Client ─────────────────────────────────────── -->
  <g filter="url(#sh)">
    <rect x="80" y="100" width="256" height="76" rx="10" fill="#FFF" stroke="#93C5FD" stroke-width="2"/>
  </g>
  <rect x="80" y="100" width="5" height="76" rx="2" fill="#3B82F6"/>
  <text x="218" y="140" text-anchor="middle" class="box-h">MCP Client</text>
  <text x="218" y="160" text-anchor="middle" class="box-s">Copilot · agent · MCP CLI</text>

  <!-- ── Participant: Code Graph Server ─────────────────────────────── -->
  <g filter="url(#sh)">
    <rect x="944" y="100" width="256" height="76" rx="10" fill="#FFF" stroke="#818CF8" stroke-width="2"/>
  </g>
  <rect x="944" y="100" width="5" height="76" rx="2" fill="#6366F1"/>
  <text x="1072" y="140" text-anchor="middle" class="box-h">Code Graph Server</text>
  <text x="1072" y="160" text-anchor="middle" class="box-s">HTTP · stdio transport</text>

  <!-- Lifelines -->
  <line x1="208" y1="176" x2="208" y2="736" stroke="#94A3B8" stroke-width="1.5" stroke-dasharray="6 5"/>
  <line x1="1072" y1="176" x2="1072" y2="736" stroke="#94A3B8" stroke-width="1.5" stroke-dasharray="6 5"/>

  <!-- ── Step 1 — POST initialize ─────────────────────────────────── -->
  <line x1="236" y1="228" x2="1044" y2="228" stroke="#475569" stroke-width="2.5" marker-end="url(#arr)"/>
  <text x="640" y="216" text-anchor="middle" class="step">① POST /mcp  method: initialize  (no session-id required)</text>

  <!-- ── Step 2 — 200 OK + mcp-session-id ───────────────────────── -->
  <line x1="1044" y1="298" x2="236" y2="298" stroke="#8B5CF6" stroke-width="2" stroke-dasharray="6 4" marker-end="url(#arr-ret)"/>
  <text x="640" y="286" text-anchor="middle" class="ret-lbl">② ← 200 OK  +  mcp-session-id: &lt;uuid&gt;  (capture and reuse on all subsequent calls)</text>

  <!-- ── Step 3 — graph_set_workspace ───────────────────────────── -->
  <line x1="236" y1="396" x2="1044" y2="396" stroke="#475569" stroke-width="2.5" marker-end="url(#arr)"/>
  <text x="640" y="384" text-anchor="middle" class="step">③ graph_set_workspace  workspaceRoot · sourceDir · projectId   (+mcp-session-id)</text>

  <!-- ── Step 3 response ────────────────────────────────────────── -->
  <line x1="1044" y1="438" x2="236" y2="438" stroke="#8B5CF6" stroke-width="2" stroke-dasharray="6 4" marker-end="url(#arr-ret)"/>
  <text x="640" y="426" text-anchor="middle" class="ret-lbl">← workspace context registered</text>

  <!-- ── Step 4 — graph_rebuild ─────────────────────────────────── -->
  <line x1="236" y1="480" x2="1044" y2="480" stroke="#475569" stroke-width="2.5" marker-end="url(#arr)"/>
  <text x="640" y="468" text-anchor="middle" class="step">④ graph_rebuild   mode: full · incremental   (+mcp-session-id)</text>

  <!-- ── Step 4 response — QUEUED ───────────────────────────────── -->
  <line x1="1044" y1="522" x2="236" y2="522" stroke="#8B5CF6" stroke-width="2" stroke-dasharray="6 4" marker-end="url(#arr-ret)"/>
  <text x="640" y="510" text-anchor="middle" class="ret-lbl">← status: QUEUED  (async rebuild — poll graph_health until indexedFiles &gt; 0)</text>

  <!-- ── Step 5 — repeatable tool calls ────────────────────────── -->
  <line x1="236" y1="610" x2="1044" y2="610" stroke="#475569" stroke-width="2.5" marker-end="url(#arr)"/>
  <text x="640" y="598" text-anchor="middle" class="step">⑤ any tool call  graph_query · graph_health · context_pack · agent_claim · …   (+mcp-session-id)  ↺ repeatable</text>

  <!-- ── Step 6 — shaped response ──────────────────────────────── -->
  <line x1="1044" y1="662" x2="236" y2="662" stroke="#8B5CF6" stroke-width="2" stroke-dasharray="6 4" marker-end="url(#arr-ret)"/>
  <text x="640" y="650" text-anchor="middle" class="ret-lbl">⑥ ← shaped response   profile: compact · balanced · debug   _tokenEstimate included</text>

  <!-- Side note on QUEUED async -->
  <rect x="752" y="532" width="282" height="34" rx="6" fill="#EEF2FF" stroke="#818CF8" stroke-width="1"/>
  <text x="893" y="553" text-anchor="middle" class="note" fill="#4F46E5">BM25 index auto-created on full rebuild · MAGE Leiden runs community detection</text>

  <!-- ── Footer ─────────────────────────────────────────────────── -->
  <rect x="30" y="746" width="1220" height="44" rx="10" fill="#E2E8F0"/>
  <text x="640" y="773" text-anchor="middle" class="footer">All non-initialize requests require mcp-session-id · graph_rebuild returns QUEUED immediately · use graph_health to confirm readiness</text>
</svg>
